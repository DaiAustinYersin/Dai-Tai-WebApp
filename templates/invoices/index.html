{% extends 'base.html' %}

{% block content %}
    <span class="title"><h1>{% block title %} Quản lý hóa đơn {% endblock %}</h1></span>
    <form action="/invoices" method="post">
        <div class="row">
            <div class="col mb-3">
                <label for="created_date" class="form-label">Ngày tạo</label>
                <input type="datetime-local" class="form-control" id="created_date" name="created_date" readonly
                       required>
            </div>
            <div class="col mb-3">
                <label for="customers" class="form-label">Khách hàng</label>
                <select class="form-select" id="customers" name="customer_id" required>
                    <option value="" selected disabled>Chọn khách hàng</option>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.id }} - {{ customer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col mb-3">
                <label for="total_price" class="form-label">Tổng tiền</label>
                <input type="number" class="form-control" id="total_price" name="total_price" readonly required>
            </div>
        </div>
        <h2>Danh sách mua hàng</h2>
        <div id="invoice-details-container">
            <div class="row mb-3 invoice-detail align-items-center">
                <div class="col">
                    <label for="product_id_1" class="form-label">Sản phẩm</label>
                    <select class="form-select" id="product_id_1" name="product_id[]" required
                            onchange="updateProductDetails(1)">
                        <option value="" selected disabled>Chọn sản phẩm</option>
                        {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.price }}"
                                    data-url="{{ product.url_img }}">{{ product.id }} - {{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col text-center">
                    <img id="url_img_1" style="width: 200px" src="" alt="Product Image">
                </div>
                <div class="col">
                    <label for="quantity_1" class="form-label">Số lượng</label>
                    <input type="number" class="form-control" id="quantity_1" name="quantity[]" value="1" min="1"
                           required oninput="updateTotalPrice(1)">
                </div>
                <div class="col">
                    <label for="price_1" class="form-label">Giá</label>
                    <input type="number" class="form-control" id="price_1" name="price[]" readonly required>
                </div>
                <div class="col">
                    <label for="total_price_1" class="form-label">Thành tiền</label>
                    <input type="number" step="0.01" class="form-control" id="total_price_1" name="total_price[]"
                           readonly required>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="addInvoiceDetail()">Thêm danh mục mua</button>
        <button type="submit" class="btn btn-primary">Tạo hóa đơn</button>
    </form>
    <hr>
    <div class="content pt-3">
        <h3>Danh sách hóa đơn</h3>
        <table class="table">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Mã hóa đơn</th>
                <th scope="col">Ngày tạo</th>
                <th scope="col">Khách hàng</th>
                <th scope="col">Tổng tiền</th>
            </tr>
            </thead>
            <tbody>
            {% for invoice in invoices %}
                <tr>
                    <td>
                        <a href="/invoices/view/{{ invoice.id }}">
                            <div class="badge bg-primary">View</div>
                        </a>
                        <a href="/invoices/delete/{{ invoice.id }}">
                            <div class="badge bg-danger">Delete</div>
                        </a>
                    </td>
                    <th scope="row">{{ invoice.id }}</th>
                    <td>{{ invoice.created_date }}</td>
                    <td>{{ invoice.customer }}</td>
                    <td>{{ invoice.total_price }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        let detailIndex = 2;

        function updateProductDetails(index) {
            const productSelect = document.getElementById(`product_id_${index}`);
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const imageUrl = selectedOption.getAttribute('data-url');

            document.getElementById(`price_${index}`).value = price;
            document.getElementById(`url_img_${index}`).src = imageUrl;

            updateTotalPrice(index);
        }

        function updateTotalPrice(index) {
            const quantityInput = document.getElementById(`quantity_${index}`);
            const priceInput = document.getElementById(`price_${index}`);
            const totalPriceInput = document.getElementById(`total_price_${index}`);
            const totalPrice = quantityInput.value * priceInput.value;
            totalPriceInput.value = totalPrice.toFixed(2);
            calculateTotalInvoicePrice();
        }

        function calculateTotalInvoicePrice() {
            let totalInvoicePrice = 0;
            const totalPriceInputs = document.querySelectorAll('[id^="total_price_"]');
            totalPriceInputs.forEach(input => {
                totalInvoicePrice += parseFloat(input.value) || 0;
            });
            document.getElementById('total_price').value = totalInvoicePrice.toFixed(2);
        }

        function addInvoiceDetail() {
            const container = document.getElementById('invoice-details-container');
            const newDetail = document.createElement('div');
            newDetail.className = 'row mb-3 invoice-detail align-items-center';
            newDetail.innerHTML = `
                <div class="col">
                    <label for="product_id_${detailIndex}" class="form-label">Sản phẩm</label>
                    <select class="form-select" id="product_id_${detailIndex}" name="product_id[]" required onchange="updateProductDetails(${detailIndex})">
                        <option value="" selected disabled>Chọn sản phẩm</option>
                        {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.price }}" data-url="
                {{ product.url_img }}">{{ product.id }} - {{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col text-center">
                    <img id="url_img_${detailIndex}" style="width: 200px" src="" alt="Product Image">
                </div>
                <div class="col">
                    <label for="quantity_${detailIndex}" class="form-label">Số lượng</label>
                    <input type="number" class="form-control" id="quantity_${detailIndex}" name="quantity[]" value="1" min="1" required oninput="updateTotalPrice(${detailIndex})">
                </div>
                <div class="col">
                    <label for="price_${detailIndex}" class="form-label">Giá</label>
                    <input type="number" class="form-control" id="price_${detailIndex}" name="price[]" readonly required>
                </div>
                <div class="col">
                    <label for="total_price_${detailIndex}" class="form-label">Thành tiền</label>
                    <input type="number" step="0.01" class="form-control" id="total_price_${detailIndex}" name="total_price[]" readonly required>
                </div>
            `;
            container.appendChild(newDetail);
            detailIndex++;
        }

        function removeInvoiceDetail(button) {
            const detailRow = button.closest('.invoice-detail');
            detailRow.remove();
        }

        document.addEventListener("DOMContentLoaded", function () {
            const createdDateInput = document.getElementById('created_date');
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            createdDateInput.value = formattedDateTime;
        });
    </script>
{% endblock %}